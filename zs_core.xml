<class name = "zs_core" script = "fsm_c">

<state name = "parsing text" inherit = "defaults">
    <event name = "number">
        <action name = "push number to output" />
        <action name = "get next token" />
    </event>
    <event name = "string">
        <action name = "push string to output" />
        <action name = "get next token" />
    </event>
    <event name = "function" next = "after function">
        <action name = "resolve function name" />
        <action name = "get next token" />
    </event>
    <event name = "close">
        <action name = "pop function" />
        <action name = "call function" />
        <action name = "get next token" />
    </event>
    <event name = "compose" next = "expecting open">
        <action name = "name must be unknown" />
        <action name = "open composition" />
        <action name = "get next token" />
    </event>
    <!-- TODO: handle multiliners -->
    <event name = "eol">
        <action name = "show pipe contents" />
        <action name = "signal success" />
    </event>
</state>

<state name = "after function" inherit = "defaults">
    <event name = "open" next = "parsing text">
        <action name = "push function" />
        <action name = "get next token" />
    </event>
    <event name = "number" next = "parsing text">
        <action name = "call function" />
        <action name = "push number to output" />
        <action name = "get next token" />
    </event>
    <event name = "string" next = "parsing text">
        <action name = "call function" />
        <action name = "push string to output" />
        <action name = "get next token" />
    </event>
    <event name = "function" next = "after function">
        <action name = "call function" />
        <action name = "resolve function name" />
        <action name = "get next token" />
    </event>
    <event name = "close">
        <action name = "call function" />
        <action name = "pop function" />
        <action name = "call function" />
        <action name = "get next token" />
    </event>
    <event name = "eol">
        <action name = "call function" />
        <action name = "show pipe contents" />
        <action name = "signal success" />
    </event>
</state>

<state name = "expecting open" inherit = "defaults">
    <event name = "open" next = "composing">
        <action name = "get next token" />
    </event>
</state>

<state name = "composing" inherit = "defaults">
    <event name = "number">
        <action name = "compose number value" />
        <action name = "get next token" />
    </event>
    <event name = "string">
        <action name = "compose string value" />
        <action name = "get next token" />
    </event>
    <event name = "function">
        <action name = "compose function" />
        <action name = "get next token" />
    </event>
    <event name = "close" next = "parsing text">
        <action name = "close composition" />
        <action name = "get next token" />
    </event>
</state>

<state name = "defaults">
    <event name = "number">
        <action name = "signal syntax error" />
    </event>
    <event name = "string">
        <action name = "signal syntax error" />
    </event>
    <event name = "function">
        <action name = "signal syntax error" />
    </event>
    <event name = "compose">
        <action name = "signal syntax error" />
    </event>
    <event name = "open">
        <action name = "signal syntax error" />
    </event>
    <event name = "close">
        <action name = "signal syntax error" />
    </event>
    <event name = "invalid">
        <action name = "signal syntax error" />
    </event>
    <event name = "eol">
        <action name = "signal success" />
    </event>
</state>

</class>
