<class name = "zs_repl" script = "fsm_c">
    This is the REPL (read-evaluate-print loop) for ZeroScript.
    http://en.wikipedia.org/wiki/Read-eval-print_loop

    We accept input from the user and compile as we go along.
    When we have a complete command we execute it, and delete
    the compiled code.

    Alternatively, the user can define functions, which can
    then be composed and executed.

<state name = "starting" inherit = "defaults">
    <event name = "number" next = "building shell">
        <action name = "compile define shell" />
        <action name = "compile number" />
        <action name = "get next token" />
    </event>
    <event name = "string" next = "building shell">
        <action name = "compile define shell" />
        <action name = "compile string" />
        <action name = "get next token" />
    </event>
    <event name = "inline fn" next = "building shell">
        <action name = "compile define shell" />
        <action name = "compile inline call" />
        <action name = "get next token" />
    </event>
    <event name = "nested fn" next = "building shell">
        <action name = "compile define shell" />
        <action name = "compile nested call" />
        <action name = "get next token" />
    </event>
    <event name = "define fn" next = "building function">
        <action name = "compile define" />
        <action name = "get next token" />
    </event>
</state>

<state name = "building shell" inherit = "building function">
    <event name = "close list">
        <action name = "compile unnest" />
        <action name = "get next token" />
    </event>
    <event name = "completed" next = "starting">
        <action name = "compile end of sentence" />
        <action name = "compile commit shell" />
        <action name = "run virtual machine" />
        <action name = "rollback the function" />
    </event>
</state>

<state name = "building function" inherit = "defaults">
    <event name = "number">
        <action name = "compile number" />
        <action name = "get next token" />
    </event>
    <event name = "string">
        <action name = "compile string" />
        <action name = "get next token" />
    </event>
    <event name = "inline fn">
        <action name = "compile inline call" />
        <action name = "get next token" />
    </event>
    <event name = "nested fn">
        <action name = "compile nested call" />
        <action name = "get next token" />
    </event>
    <event name = "close list">
        <action name = "compile unnest or commit" />
        <action name = "get next token" />
    </event>
    <event name = "phrase">
        <action name = "compile end of phrase" />
        <action name = "get next token" />
    </event>
    <event name = "sentence">
        <action name = "compile end of sentence" />
        <action name = "get next token" />
    </event>
</state>

<state name = "defaults">
    <event name = "finished">
        <action name = "check if completed" />
    </event>
    <event name = "completed" next = "starting">
    </event>
    <event name = "number" next = "starting">
        <action name = "rollback the function" />
        <action name = "signal syntax error" />
    </event>
    <event name = "string" next = "starting">
        <action name = "rollback the function" />
        <action name = "signal syntax error" />
    </event>
    <event name = "inline fn" next = "starting">
        <action name = "rollback the function" />
        <action name = "signal syntax error" />
    </event>
    <event name = "nested fn" next = "starting">
        <action name = "rollback the function" />
        <action name = "signal syntax error" />
    </event>
    <event name = "define fn" next = "starting">
        <action name = "rollback the function" />
        <action name = "signal syntax error" />
    </event>
    <event name = "phrase" next = "starting">
        <action name = "rollback the function" />
        <action name = "signal syntax error" />
    </event>
    <event name = "sentence" next = "starting">
        <action name = "rollback the function" />
        <action name = "signal syntax error" />
    </event>
    <event name = "close list" next = "starting">
        <action name = "rollback the function" />
        <action name = "signal syntax error" />
    </event>
    <event name = "invalid" next = "starting">
        <action name = "rollback the function" />
        <action name = "signal syntax error" />
    </event>
</state>

</class>
